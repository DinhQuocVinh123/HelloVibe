name: HelloVibe CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1ï¸âƒ£ Checkout code
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2ï¸âƒ£ Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # 3ï¸âƒ£ Install Salesforce CLI
    - name: Install Salesforce CLI
      run: |
        set -e
        curl https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz | tar xJf -
        ./sfdx/bin/sf --version

    # 4ï¸âƒ£ Authenticate to Dev Org
    - name: Authenticate to Salesforce Dev Org using SFDX URL
      run: |
        set -e
        echo "${{ secrets.SFDX_AUTH_URL }}" > sfdx_auth.txt
        ./sfdx/bin/sf org login sfdx-url -f sfdx_auth.txt --set-default --alias hellovibe-dev
        ./sfdx/bin/sf org display --target-org hellovibe-dev

    # 5ï¸âƒ£ Backup current metadata (requires manifest/package.xml)
    - name: Backup Current Org Metadata
      id: backup_metadata
      run: |
        set -e
        echo "ğŸ§© Starting metadata backup..."
        mkdir -p backups/previous
        startTime=$(date +%s)

        # âœ… Run backup and catch errors
        if ./sfdx/bin/sf project retrieve start --manifest manifest/package.xml --target-org hellovibe-dev --output-dir backups/previous; then
          echo "âœ… Backup completed successfully."
          status="success"
        else
          echo "âŒ Backup failed during metadata retrieval."
          status="failed"
        fi

        endTime=$(date +%s)
        duration=$((endTime - startTime))
        echo "â±ï¸ Backup duration: ${duration} seconds"
        echo "backup_time=$duration" >> $GITHUB_ENV
        echo "backup_status=$status" >> $GITHUB_ENV

        # Ghi log ra file Ä‘á»ƒ lÆ°u artifact
        echo "Backup Status: $status" > backups/backup_log.txt
        echo "Duration: $duration seconds" >> backups/backup_log.txt
        echo "Completed at: $(date)" >> backups/backup_log.txt

    # 6ï¸âƒ£ Get current commit hash
    - name: Get Current Commit Hash
      id: get_commit
      run: |
        COMMIT_HASH=$(git rev-parse HEAD)
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_ENV
        echo "Current commit: $COMMIT_HASH"

    # 7ï¸âƒ£ Deploy source to org
    - name: Deploy Source to Dev Org
      id: deploy_source
      run: |
        set -e
        echo "ğŸš€ Deploying source to Dev Org..."
        startTime=$(date +%s)
        ./sfdx/bin/sf project deploy start --source-dir force-app --target-org hellovibe-dev --ignore-conflicts --api-version 64.0 --wait 10 --verbose
        endTime=$(date +%s)
        duration=$((endTime - startTime))
        echo "âœ… Deployment completed in $duration seconds"
        echo "source_deploy_time=$duration" >> $GITHUB_ENV

    # 8ï¸âƒ£ (Optional) Run Apex Tests with Coverage
    # - name: Run Apex Tests with Coverage
    #   id: run_tests
    #   run: |
    #     set -e
    #     echo "Running Apex tests..."
    #     startTime=$(date +%s)
    #     ./sfdx/bin/sf apex run test -o hellovibe-dev --wait 10 --result-format json > test-result.json
    #     coverage=$(grep -o '"coveragePercentage":[0-9]*\.[0-9]*' test-result.json | sed 's/"coveragePercentage"://')
    #     if [ -z "$coverage" ]; then coverage="0"; fi
    #     echo "Coverage: ${coverage}%"
    #     if (( $(echo "$coverage < 85" | bc -l) )); then
    #       echo "âŒ Coverage too low: ${coverage}%"
    #       exit 1
    #     fi
    #     endTime=$(date +%s)
    #     duration=$((endTime - startTime))
    #     echo "Tests completed in $duration seconds"
    #     echo "test_execution_time=$duration" >> $GITHUB_ENV

    # 9ï¸âƒ£ Rollback on failure
    - name: Rollback on Deployment Failure
      if: failure()
      run: |
        set -e
        echo "âŒ Deployment failed â€” initiating rollback..."
        echo "ğŸ”„ Reverting GitHub to previous commit (excluding workflow files)..."
        git reset --hard HEAD~1
        git restore --staged .github/workflows/pipeline.yml || true
        git push origin main --force
        echo "ğŸ” Restoring previous metadata to org..."
        ./sfdx/bin/sf project deploy start --source-dir backups/previous --target-org hellovibe-dev --ignore-conflicts --wait 10
        echo "âœ… Rollback completed successfully."


    # ğŸ”Ÿ Log summary
    - name: Log Execution Times
      run: |
        echo "=== ğŸ§¾ Pipeline Execution Summary ==="
        echo "ğŸ“¦ Metadata Backup: ${{ env.backup_time }} seconds - Status: ${{ env.backup_status }}"
        echo "ğŸš€ Source Deployment: ${{ env.source_deploy_time }} seconds"
        echo "ğŸ” Commit Hash: ${{ env.commit_hash }}"
        echo "====================================="
    